<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-image: url('003.png');
        background-size: cover;
        background-position: top center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        text-align: center;
        padding: 50px;
      }
      #spinSound, #finishSound {
        display: none;
      }

      h1, h4 {
        color: rgba(0, 0, 0, 0);
      }

      .slot-machine-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 40px;
        gap: 0px;
      }

      .reel-box {
        width: 250px;
        height: 80px;
        border-radius: 10px;
        font-size: 50px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 0 10px;
        box-sizing: border-box;
      }

      button {
        margin: 10px;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ff9900;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #e68a00;
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      #resetHistoryButton {
        background-color: #666;
      }
      #resetHistoryButton:hover {
        background-color: #555;
      }

      #restartButton {
        background-color: #0066cc;
      }
      #restartButton:hover {
        background-color: #005bb5;
      }

      #result {
        margin-top: 30px;
        font-size: 18px;
        color: #333;
        font-weight: bold;
      }

      #result b {
        color: #003366;
      }

      #history {
        margin-top: 40px;
        text-align: left;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        min-height: 100px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        max-height: 250px;
      }

      #history div {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h1>1</h1>
    <h1>2</h1>
    <h1>2</h1>
    <h1>2</h1>

    <div class="slot-machine-wrapper">
      <div id="areaReel" class="reel-box">--</div>
      <div id="numberReel" class="reel-box">--</div>
    </div>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />

    <audio id="spinSound" src="002.mp3" preload="auto"></audio>
    <audio id="finishSound" src="002.mp3" preload="auto"></audio>

    <button id="drawButton" onclick="startDraw()">é–‹å§‹æŠ½é¸</button>
    <button id="retryNumberButton" onclick="retryNumber()" disabled>é‡æŠ½ç›®å‰ç·¨è™Ÿ</button>
    <button id="resetHistoryButton" onclick="resetHistory()">æ¸…é™¤ç´€éŒ„</button>
    <button id="restartButton" onclick="restartAll()">ğŸ”„ é‡æ–°é–‹å§‹</button>

    <div id="result"></div>
    <div id="history"><strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong></div>

    <script>
      // å¾ Google è©¦ç®—è¡¨è¼‰å…¥çš„è³‡æ–™
      let areaListA = [];
      let areaNames = [];
      let areaMap = {};
      let drawnMap = {};
      let lastSelectedArea = null;

      const spinSound = document.getElementById('spinSound');
      const finishSound = document.getElementById('finishSound');

      // =================================== è¼‰å…¥è³‡æ–™å‡½å¼ ===================================
      /**
       * å¾ Google è©¦ç®—è¡¨çš„ Apps Script è®€å–æŠ½çè³‡æ–™ã€‚
       */
      async function loadDataFromGoogleSheet() {
        const url = 'https://script.google.com/macros/s/AKfycbwrbfpDXGDH7x70OdXkNNZ05ux3eJocrXVDouYbVQBakHa8uVnNwY42KJmG2cV257CFFg/exec'; // åœ¨é€™è£¡è²¼ä¸Šä½ çš„ URL
        
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
          }
          const data = await response.json();
          
          areaListA = data.areaListA;
          areaNames = data.areaNames;
          areaMap = data.areaMap;
          
          console.log('è³‡æ–™å·²æˆåŠŸå¾ Google è©¦ç®—è¡¨è¼‰å…¥ã€‚');
        } catch (error) {
          console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
          alert('è¼‰å…¥æŠ½çåå–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²é æ‡‰ç”¨ç¨‹å¼ URL æ˜¯å¦æ­£ç¢ºï¼Œæˆ–è©¦ç®—è¡¨è³‡æ–™æ ¼å¼æ˜¯å¦æœ‰èª¤ã€‚');
        }
      }

      window.onload = () => {
        loadDataFromGoogleSheet();
      };
      // =================================== è¼‰å…¥è³‡æ–™å‡½å¼çµæŸ ===================================

      /**
       * æ’­æ”¾è½‰å‹•éŸ³æ•ˆã€‚
       */
      function playSpinSound() {
        if (spinSound) {
          spinSound.currentTime = 0;
          spinSound.play().catch(e => console.log("è½‰å‹•éŸ³é »æ’­æ”¾å¤±æ•—:", e));
        }
      }

      /**
       * åœæ­¢è½‰å‹•éŸ³æ•ˆã€‚
       */
      function stopSpinSound() {
        if (spinSound) {
          spinSound.pause();
          spinSound.currentTime = 0;
        }
      }

      /**
       * æ’­æ”¾çµæŸéŸ³æ•ˆçš„ç‰¹å®šå€æ®µã€‚
       * @param {number} startTime - éŸ³æ•ˆé–‹å§‹æ’­æ”¾çš„ç§’æ•¸ã€‚
       * @param {number} duration - éŸ³æ•ˆæŒçºŒæ’­æ”¾çš„ç§’æ•¸ã€‚
       */
      function playFinishSound(startTime, duration) {
        if (finishSound) {
          finishSound.currentTime = startTime;
          finishSound.play().catch(e => console.log("çµæŸéŸ³é »æ’­æ”¾å¤±æ•—:", e));

          setTimeout(() => {
            finishSound.pause();
            finishSound.currentTime = 0;
          }, duration * 1000);
        }
      }

      /**
       * é–‹å§‹æŠ½é¸æµç¨‹ã€‚
       */
      function startDraw() {
        document.getElementById('drawButton').disabled = true;
        document.getElementById('retryNumberButton').disabled = true;
        document.getElementById('result').innerHTML = '';
        document.getElementById('areaReel').innerText = '--';
        document.getElementById('numberReel').innerText = '--';
        
        playSpinSound();
        spinAreaFirst();
      }

      /**
       * è½‰å‹•å€åŸŸè¼ªç›¤ã€‚
       */
      function spinAreaFirst() {
        const availableRealAreas = areaNames.filter(area => {
          const areaNumbers = areaMap[area];
          if (!areaNumbers || areaNumbers.length === 0) {
            return false;
          }
          if (areaNumbers.length === 1 && areaNumbers[0] === 'å€') {
            return !drawnMap[area] || !drawnMap[area].includes('å€');
          }
          if (!drawnMap[area]) return true;
          return drawnMap[area].length < areaNumbers.length;
        });

        if (availableRealAreas.length === 0) {
          alert("æ‰€æœ‰çœŸå¯¦å€åŸŸçš„ç·¨è™Ÿéƒ½æŠ½å®Œäº†ï¼Œè«‹æŒ‰ã€Œé‡æ–°é–‹å§‹ã€é‡æ–°æŠ½é¸ï¼");
          document.getElementById('drawButton').disabled = false;
          stopSpinSound();
          return;
        }

        const areaReel = document.getElementById('areaReel');
        let spinDuration = 2000 + Math.random() * 1000;
        let start = null;

        function animate(time) {
          if (!start) start = time;
          const progress = time - start;
          const i = Math.floor(progress / 80) % areaListA.length;
          areaReel.innerText = areaListA[i];

          if (progress < spinDuration) {
            requestAnimationFrame(animate);
          } else {
            const finalArea = availableRealAreas[Math.floor(Math.random() * availableRealAreas.length)];
            areaReel.innerText = finalArea;
            lastSelectedArea = finalArea;

            stopSpinSound();
            spinNumber(finalArea);
          }
        }
        requestAnimationFrame(animate);
      }

      /**
       * è½‰å‹•ç·¨è™Ÿè¼ªç›¤ã€‚
       */
      function spinNumber(area) {
        const allNumbersWithSuffix = areaMap[area];
        const numberReel = document.getElementById('numberReel');

        if (!allNumbersWithSuffix || allNumbersWithSuffix.length === 0 || (allNumbersWithSuffix.length === 1 && allNumbersWithSuffix[0] === 'å€')) {
          const displayValue = (allNumbersWithSuffix && allNumbersWithSuffix[0] === 'å€') ? 'å€' : '--';
          numberReel.innerText = displayValue;

          if (!drawnMap[area]) drawnMap[area] = [];
          if (!drawnMap[area].includes('å€')) {
            drawnMap[area].push('å€');
          }
          
          document.getElementById('history').innerHTML += `<div>ğŸ”¹ <b>${area}</b> (å€)</div>`;
          const historyDiv = document.getElementById('history');
          historyDiv.scrollTop = historyDiv.scrollHeight;

          document.getElementById('drawButton').disabled = false;
          document.getElementById('retryNumberButton').disabled = true;
          stopSpinSound();
          return;
        }

        if (!drawnMap[area]) drawnMap[area] = [];
        const remainingNumbersWithSuffix = allNumbersWithSuffix.filter(n => !drawnMap[area].includes(n));

        if (remainingNumbersWithSuffix.length === 0) {
          numberReel.innerText = 'å·²æŠ½å®Œ';
          document.getElementById('result').innerHTML = `âš ï¸ <b>${area}</b> çš„ç·¨è™Ÿå·²å…¨éƒ¨æŠ½å®Œï¼Œæ­¤å€åŸŸå°‡ä¸å†åƒèˆ‡æŠ½é¸ã€‚`;
          document.getElementById('drawButton').disabled = false;
          document.getElementById('retryNumberButton').disabled = true;
          stopSpinSound();
          return;
        }

        playSpinSound();
        let spinDuration = 2000 + Math.random() * 1000;
        let start = null;

        function animate(time) {
          if (!start) start = time;
          const progress = time - start;
          const i = Math.floor(progress / 80) % remainingNumbersWithSuffix.length;
          numberReel.innerText = remainingNumbersWithSuffix[i];

          if (progress < spinDuration) {
            requestAnimationFrame(animate);
          } else {
            const finalNumberWithSuffix = remainingNumbersWithSuffix[Math.floor(Math.random() * remainingNumbersWithSuffix.length)];
            
            numberReel.innerText = finalNumberWithSuffix;
            drawnMap[area].push(finalNumberWithSuffix);

            document.getElementById('history').innerHTML += `<div>ğŸ”¹ <b>${area}</b> <b>${finalNumberWithSuffix}</b></div>`;
            const historyDiv = document.getElementById('history');
            historyDiv.scrollTop = historyDiv.scrollHeight;

            document.getElementById('drawButton').disabled = false;
            document.getElementById('retryNumberButton').disabled = false;
            stopSpinSound();
            playFinishSound(9, 2);
          }
        }
        requestAnimationFrame(animate);
      }

      /**
       * é‡æŠ½ç›®å‰ç·¨è™Ÿã€‚
       */
      function retryNumber() {
        if (!lastSelectedArea) {
          alert("è«‹å…ˆæŠ½å‡ºä¸€å€‹å€åŸŸï¼");
          return;
        }
        const areaNumbers = areaMap[lastSelectedArea];
        if (!areaNumbers || areaNumbers.length === 0 || (areaNumbers.length === 1 && areaNumbers[0] === 'å€')) {
            alert("æ­¤å–®ä½æ²’æœ‰ç·¨è™Ÿå¯ä¾›é‡æŠ½ã€‚");
            return;
        }

        document.getElementById('result').innerHTML = '';
        document.getElementById('numberReel').innerText = '--';
        document.getElementById('drawButton').disabled = true;
        document.getElementById('retryNumberButton').disabled = true;

        if (drawnMap[lastSelectedArea] && drawnMap[lastSelectedArea].length > 0) {
          const lastDrawn = drawnMap[lastSelectedArea].pop();
          console.log(`é‡æŠ½ï¼šå°‡ ${lastSelectedArea} çš„ ${lastDrawn} å¾å·²æŠ½è¨˜éŒ„ä¸­ç§»é™¤ã€‚`);
          
          const historyDiv = document.getElementById('history');
          if (historyDiv.lastElementChild && historyDiv.lastElementChild.tagName === 'DIV') {
            historyDiv.removeChild(historyDiv.lastElementChild);
          }
        }
        if (finishSound) {
          finishSound.pause();
          finishSound.currentTime = 0;
        }
        spinNumber(lastSelectedArea);
      }

      /**
       * æ¸…é™¤æ­·å²ç´€éŒ„ã€‚
       */
      function resetHistory() {
        document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
      }

      /**
       * é‡ç½®æ‰€æœ‰æŠ½çè³‡æ–™ï¼Œé‡æ–°é–‹å§‹ã€‚
       */
      function restartAll() {
        drawnMap = {};
        lastSelectedArea = null;
        document.getElementById('areaReel').innerText = '--';
        document.getElementById('numberReel').innerText = '--';
        document.getElementById('result').innerHTML = '';
        document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
        document.getElementById('drawButton').disabled = false;
        document.getElementById('retryNumberButton').disabled = true;
        alert("æ‰€æœ‰è³‡æ–™å·²é‡ç½®ï¼Œé‡æ–°é–‹å§‹æŠ½é¸ï¼");
        stopSpinSound();
        if (finishSound) {
          finishSound.pause();
          finishSound.currentTime = 0;
        }
      }
    </script>
  </body>
</html>
