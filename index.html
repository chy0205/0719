<script>
  // 從 Google 試算表載入的資料
  let areaListA = [];
  let areaNames = [];
  let areaMap = {};
  let drawnMap = {};
  let lastDrawnResult = null;

  const spinSound = document.getElementById('spinSound');
  const finishSound = document.getElementById('finishSound');

  // =================================== 載入資料與洗牌函式 ===================================

  /**
   * 洗牌函式（Fisher-Yates shuffle）。
   * @param {Array} array - 要打亂的陣列。
   */
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  /**
   * 從 Google 試算表的 Apps Script 讀取抽獎資料並打亂名單。
   */
  async function loadDataFromGoogleSheet() {
    const url = 'https://script.google.com/macros/s/AKfycbwrbfpDXGDH7x70OdXkNNZ05ux3eJocrXVDouYbVQBakHa8uVnNwY42KJmG2cV257CFFg/exec'; // 在這裡貼上你的 URL
    
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
      }
      const data = await response.json();
      
      areaListA = data.areaListA;
      areaNames = data.areaNames;
      areaMap = data.areaMap;
      
      // ------------------------------------- 新增的洗牌邏輯 -------------------------------------
      // 1. 打亂區域名稱列表
      shuffleArray(areaNames);

      // 2. 打亂每個區域內的編號列表
      for (const area in areaMap) {
        if (areaMap.hasOwnProperty(area)) {
          shuffleArray(areaMap[area]);
        }
      }
      console.log('資料已成功從 Google 試算表載入並打亂。');
      // --------------------------------------------------------------------------------------
    } catch (error) {
      console.error('載入資料失敗:', error);
      alert('載入抽獎名單失敗，請檢查網頁應用程式 URL 是否正確，或試算表資料格式是否有誤。');
    }
  }

  window.onload = () => {
    loadDataFromGoogleSheet();
  };
  // =================================== 載入資料與洗牌函式結束 ===================================

  /**
   * 播放轉動音效。
   */
  function playSpinSound() {
    if (spinSound) {
      spinSound.currentTime = 0;
      spinSound.play().catch(e => console.log("轉動音頻播放失敗:", e));
    }
  }

  /**
   * 停止轉動音效。
   */
  function stopSpinSound() {
    if (spinSound) {
      spinSound.pause();
      spinSound.currentTime = 0;
    }
  }

  /**
   * 播放結束音效的特定區段。
   * @param {number} startTime - 音效開始播放的秒數。
   * @param {number} duration - 音效持續播放的秒數。
   */
  function playFinishSound(startTime, duration) {
    if (finishSound) {
      finishSound.currentTime = startTime;
      finishSound.play().catch(e => console.log("結束音頻播放失敗:", e));

      setTimeout(() => {
        finishSound.pause();
        finishSound.currentTime = 0;
      }, duration * 1000);
    }
  }

  /**
   * 開始抽選流程。
   */
  function startDraw() {
    document.getElementById('drawButton').disabled = true;
    document.getElementById('result').innerHTML = '';
    document.getElementById('mainReel').innerText = '--';
    
    playSpinSound();
    spinReel();
  }

  /**
   * 轉動主要輪盤。
   */
  function spinReel() {
    let availableResults = [];
    areaNames.forEach(area => {
      const numbers = areaMap[area];
      if (!numbers) return;
      numbers.forEach(number => {
        if (!drawnMap[area] || !drawnMap[area].includes(number)) {
          availableResults.push(`${area} ${number}`);
        }
      });
    });

    if (availableResults.length === 0) {
      alert("所有編號都抽完了，請按「重新開始」重新抽選！");
      document.getElementById('drawButton').disabled = false;
      stopSpinSound();
      return;
    }

    const mainReel = document.getElementById('mainReel');
    let spinDuration = 2000 + Math.random() * 1000;
    let start = null;

    function animate(time) {
      if (!start) start = time;
      const progress = time - start;
      const i = Math.floor(progress / 80) % availableResults.length;
      mainReel.innerText = availableResults[i];

      if (progress < spinDuration) {
        requestAnimationFrame(animate);
      } else {
        const finalResult = availableResults[Math.floor(Math.random() * availableResults.length)];
        
        mainReel.innerText = finalResult;
        lastDrawnResult = finalResult;

        const [area, ...numberParts] = finalResult.split(' ');
        const number = numberParts.join(' ');
        if (!drawnMap[area]) {
            drawnMap[area] = [];
        }
        drawnMap[area].push(number);

        document.getElementById('history').innerHTML += `<div>🔹 <b>${finalResult}</b></div>`;
        const historyDiv = document.getElementById('history');
        historyDiv.scrollTop = historyDiv.scrollHeight;

        document.getElementById('drawButton').disabled = false;
        stopSpinSound();
        playFinishSound(9, 2);
      }
    }
    requestAnimationFrame(animate);
  }
  
  /**
   * 清除歷史紀錄。
   */
  function resetHistory() {
    document.getElementById('history').innerHTML = '<strong>🎯 抽選紀錄：</strong>';
  }

  /**
   * 重置所有抽獎資料，重新開始。
   */
  function restartAll() {
    drawnMap = {};
    lastDrawnResult = null;
    document.getElementById('mainReel').innerText = '--';
    document.getElementById('result').innerHTML = '';
    document.getElementById('history').innerHTML = '<strong>🎯 抽選紀錄：</strong>';
    document.getElementById('drawButton').disabled = false;
    alert("所有資料已重置，重新開始抽選！");
    stopSpinSound();
    if (finishSound) {
      finishSound.pause();
      finishSound.currentTime = 0;
    }
  }
</script>
