<script>
  // å¾ Google è©¦ç®—è¡¨è¼‰å…¥çš„è³‡æ–™
  let areaListA = [];
  let areaNames = [];
  let areaMap = {};
  let drawnMap = {};
  let lastDrawnResult = null;

  const spinSound = document.getElementById('spinSound');
  const finishSound = document.getElementById('finishSound');

  // =================================== è¼‰å…¥è³‡æ–™èˆ‡æ´—ç‰Œå‡½å¼ ===================================

  /**
   * æ´—ç‰Œå‡½å¼ï¼ˆFisher-Yates shuffleï¼‰ã€‚
   * @param {Array} array - è¦æ‰“äº‚çš„é™£åˆ—ã€‚
   */
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  /**
   * å¾ Google è©¦ç®—è¡¨çš„ Apps Script è®€å–æŠ½çè³‡æ–™ä¸¦æ‰“äº‚åå–®ã€‚
   */
  async function loadDataFromGoogleSheet() {
    const url = 'https://script.google.com/macros/s/AKfycbwrbfpDXGDH7x70OdXkNNZ05ux3eJocrXVDouYbVQBakHa8uVnNwY42KJmG2cV257CFFg/exec'; // åœ¨é€™è£¡è²¼ä¸Šä½ çš„ URL
    
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
      }
      const data = await response.json();
      
      areaListA = data.areaListA;
      areaNames = data.areaNames;
      areaMap = data.areaMap;
      
      // ------------------------------------- æ–°å¢çš„æ´—ç‰Œé‚è¼¯ -------------------------------------
      // 1. æ‰“äº‚å€åŸŸåç¨±åˆ—è¡¨
      shuffleArray(areaNames);

      // 2. æ‰“äº‚æ¯å€‹å€åŸŸå…§çš„ç·¨è™Ÿåˆ—è¡¨
      for (const area in areaMap) {
        if (areaMap.hasOwnProperty(area)) {
          shuffleArray(areaMap[area]);
        }
      }
      console.log('è³‡æ–™å·²æˆåŠŸå¾ Google è©¦ç®—è¡¨è¼‰å…¥ä¸¦æ‰“äº‚ã€‚');
      // --------------------------------------------------------------------------------------
    } catch (error) {
      console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
      alert('è¼‰å…¥æŠ½çåå–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²é æ‡‰ç”¨ç¨‹å¼ URL æ˜¯å¦æ­£ç¢ºï¼Œæˆ–è©¦ç®—è¡¨è³‡æ–™æ ¼å¼æ˜¯å¦æœ‰èª¤ã€‚');
    }
  }

  window.onload = () => {
    loadDataFromGoogleSheet();
  };
  // =================================== è¼‰å…¥è³‡æ–™èˆ‡æ´—ç‰Œå‡½å¼çµæŸ ===================================

  /**
   * æ’­æ”¾è½‰å‹•éŸ³æ•ˆã€‚
   */
  function playSpinSound() {
    if (spinSound) {
      spinSound.currentTime = 0;
      spinSound.play().catch(e => console.log("è½‰å‹•éŸ³é »æ’­æ”¾å¤±æ•—:", e));
    }
  }

  /**
   * åœæ­¢è½‰å‹•éŸ³æ•ˆã€‚
   */
  function stopSpinSound() {
    if (spinSound) {
      spinSound.pause();
      spinSound.currentTime = 0;
    }
  }

  /**
   * æ’­æ”¾çµæŸéŸ³æ•ˆçš„ç‰¹å®šå€æ®µã€‚
   * @param {number} startTime - éŸ³æ•ˆé–‹å§‹æ’­æ”¾çš„ç§’æ•¸ã€‚
   * @param {number} duration - éŸ³æ•ˆæŒçºŒæ’­æ”¾çš„ç§’æ•¸ã€‚
   */
  function playFinishSound(startTime, duration) {
    if (finishSound) {
      finishSound.currentTime = startTime;
      finishSound.play().catch(e => console.log("çµæŸéŸ³é »æ’­æ”¾å¤±æ•—:", e));

      setTimeout(() => {
        finishSound.pause();
        finishSound.currentTime = 0;
      }, duration * 1000);
    }
  }

  /**
   * é–‹å§‹æŠ½é¸æµç¨‹ã€‚
   */
  function startDraw() {
    document.getElementById('drawButton').disabled = true;
    document.getElementById('result').innerHTML = '';
    document.getElementById('mainReel').innerText = '--';
    
    playSpinSound();
    spinReel();
  }

  /**
   * è½‰å‹•ä¸»è¦è¼ªç›¤ã€‚
   */
  function spinReel() {
    let availableResults = [];
    areaNames.forEach(area => {
      const numbers = areaMap[area];
      if (!numbers) return;
      numbers.forEach(number => {
        if (!drawnMap[area] || !drawnMap[area].includes(number)) {
          availableResults.push(`${area} ${number}`);
        }
      });
    });

    if (availableResults.length === 0) {
      alert("æ‰€æœ‰ç·¨è™Ÿéƒ½æŠ½å®Œäº†ï¼Œè«‹æŒ‰ã€Œé‡æ–°é–‹å§‹ã€é‡æ–°æŠ½é¸ï¼");
      document.getElementById('drawButton').disabled = false;
      stopSpinSound();
      return;
    }

    const mainReel = document.getElementById('mainReel');
    let spinDuration = 2000 + Math.random() * 1000;
    let start = null;

    function animate(time) {
      if (!start) start = time;
      const progress = time - start;
      const i = Math.floor(progress / 80) % availableResults.length;
      mainReel.innerText = availableResults[i];

      if (progress < spinDuration) {
        requestAnimationFrame(animate);
      } else {
        const finalResult = availableResults[Math.floor(Math.random() * availableResults.length)];
        
        mainReel.innerText = finalResult;
        lastDrawnResult = finalResult;

        const [area, ...numberParts] = finalResult.split(' ');
        const number = numberParts.join(' ');
        if (!drawnMap[area]) {
            drawnMap[area] = [];
        }
        drawnMap[area].push(number);

        document.getElementById('history').innerHTML += `<div>ğŸ”¹ <b>${finalResult}</b></div>`;
        const historyDiv = document.getElementById('history');
        historyDiv.scrollTop = historyDiv.scrollHeight;

        document.getElementById('drawButton').disabled = false;
        stopSpinSound();
        playFinishSound(9, 2);
      }
    }
    requestAnimationFrame(animate);
  }
  
  /**
   * æ¸…é™¤æ­·å²ç´€éŒ„ã€‚
   */
  function resetHistory() {
    document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
  }

  /**
   * é‡ç½®æ‰€æœ‰æŠ½çè³‡æ–™ï¼Œé‡æ–°é–‹å§‹ã€‚
   */
  function restartAll() {
    drawnMap = {};
    lastDrawnResult = null;
    document.getElementById('mainReel').innerText = '--';
    document.getElementById('result').innerHTML = '';
    document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
    document.getElementById('drawButton').disabled = false;
    alert("æ‰€æœ‰è³‡æ–™å·²é‡ç½®ï¼Œé‡æ–°é–‹å§‹æŠ½é¸ï¼");
    stopSpinSound();
    if (finishSound) {
      finishSound.pause();
      finishSound.currentTime = 0;
    }
  }
</script>
